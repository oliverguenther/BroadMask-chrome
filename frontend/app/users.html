<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<title>Manage Users</title>
		<link rel="stylesheet" href="../css/bootstrap.css" type="text/css" charset="utf-8"/>
		<link rel="stylesheet" href="../css/app.css" type="text/css" charset="utf-8"/>
		<script src="/shared/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/jquery.watch.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/bootstrap.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/app.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" charset="utf-8">

			var bg = chrome.extension.getBackgroundPage(),
			bm = bg.broadmask;


			function cached_friends() {
				try {
					return bm.osn.cache().friends;
				} catch (e) {
					console.error("Couldn't read from facebook cache. " + e);
					return {};
				}
			}


			function print_stored_map() {
				var users = bm.module.gpg_associatedKeys(),
				friends = cached_friends();
				var rows = [];
				$.each(users, function(id, key_id) {
					var friend_name = friends[id];
					rows.push("<tr><td>");
					rows.push(friend_name);
					rows.push("</td><td>");
					rows.push(id);
					rows.push("</td><td>");
					rows.push(key_id);
					rows.push('</td><td class="centered"><a href="javascript:keylist_remove(');
					rows.push(id); 
					rows.push(')"><i class="icon-minus-sign"></i></a></td></tr>');
				});
				if (rows.length > 0) {
					$("#user_list").replaceWith('<table class="table table-bordered table-striped"><thead><tr><th>Name</th><th>ID</th><th>PGP Key-ID</th><th>Remove</th></tr></thead><tbody>' + rows.join("") + '</tbody></table>');
				}

			}

			function keylist_remove(userid) {
				if (confirm("Do you want to disable the GPG key mapping for user " + userid + "?")) {
					bm.module.gpg_remove_key(String(userid));
					location.reload(true);
				}
			}

			function parsePGPkey(data) {
				if (!data.hasOwnProperty("message")) {
					return;
				}
				var keyid = data.message.toLowerCase().match(/0x[a-z0-9]+/i);
				if (keyid[0]) {
					$.get("http://pgp.mit.edu:11371/pks/lookup", {op : "get", search : keyid[0]}, function (response) {
						var key_result = $(response).filter("pre");
						if (key_result && key_result.length > 0) {
							var result = bm.module.gpg_import_key(key_result[0].innerText, true);
							if (!result || result.error) {
								error("Could not import key. Error was: " + result.error_msg);
							} else if (Object.size(result.imports) === 1) {
								var imported_key = Object.pop(result.imports);
								bm.module.gpg_store_keyid(data.actor_id.toString(), imported_key.fingerprint);
								print_stored_map();
							} else {
									console.log("Found multiple keys for " + data.actor_id + ": " + JSON.stringify(result) + " . Insert mapping manually");
							}
						}
					});
				}
			}

			$(document).ready(function () {
				print_stored_map();

				/** Create autocomplete cache for friends */
				var typeaheadFriends = function () {
					var friends = cached_friends();
					if (Object.size(friends) === 0) {
						disableForm("#create_user_map");
					}

					var users_typeahead = [], 
					users_id_map = {};

					$.each(friends, function (id, name) {
						users_typeahead.push(name);
						users_id_map[name] = id;
					});
					$("#friend_name").typeahead({
						"source": users_typeahead,
						"items": 5,
					});

					$("#btn-create-mapping").click(function () {
						$("#create_user_success").hide();
						resetFormErrors();
						var user = {};

						if (!$("#friend_name").val()) {
							return formError("#friend_name", "No user name specified");
						}
						user.name = $("#friend_name").val();
						user.id = users_id_map[user.name];
						if (!user.id) {
							return formError("#friend_name", "User id for user " + user.name + " not found.");
						}

						if ($("#key_id").val()) {
							user.key_id = $("#key_id").val().split(" ").join(""); // remove spaces from fingerprint
							var result = bm.module.gpg_import_key(user.key_id, false);

							if (result.error) {
								return formError("#key_id", "Could not find key with id " + user.key_id + ". Error was: " + result.error_msg);
							} else if (Object.size(result) === 1) {
								bm.module.gpg_store_keyid(user.id, user.key_id);
								$("#create_user_success").show();
								resetForm("#create_user_map");
								print_stored_map();
							} else {
								return formError("#key_id", "Couldn't find unique key-id. Input yielded " + Object.size(result)  + " results. Enter a complete PGP-key id or fingerprint");
							}
						} else if ($("#key_block").val()) {
							var key_data = $("#key_block").val();
							var result = bm.module.gpg_import_key(key_data, true);
							if (!result || result.error) {
								return formError("#key_block", "Could not import key. Error was: " + result.error_msg);
							} else if (Object.size(result.imports) === 1) {
								var imported_key = Object.pop(result.imports);
								bm.module.gpg_store_keyid(user.id, imported_key.fingerprint);
								$("#create_user_success").show();
								resetForm("#create_user_map");
								print_stored_map();
							} else {
									return formError("#key_block", "Couldn't extract PGP-key. (Found " + Object.size(result.imports) + " keys). Paste one PGP-block only!");
							}
						}
						return false;
					});
				};

				if (localStorage.facebook_cache) {
					typeaheadFriends();
				} else {
					// Check and update cache
					bm.osn.checkCache(typeaheadFriends);
				}



				// mapping refresh
				$("#user_mapping_refresh").click(function () {
					$(this).button('loading');//AND app_id=281109321931593 
					query = "SELECT post_id, actor_id, target_id, message FROM stream WHERE filter_key = 'others' AND strpos(lower(message), 'My PGP-Key:')"; //AND NOT actor_id=me()";
					bm.osn.getFBData("https://api.facebook.com/method/fql.query?format=json&query=" + encodeURIComponent(query), function (data) {
						if (data.length > 0) {
							for (var i = 0, len = data.length; i < len; i++) {
								parsePGPkey(data[i]);
							}
						} else {
							console.log("No keys found.");
							console.log(data);
						}
					});
				});

			});
		</script>
	</head>
	<body>
		<div id="header">
			<h1><span i18n>extName</span> <small><span i18n>title</span></small></h1>
		</div>
		<div class="container">
			<div class="row">
				<div class="span3">
					<ul id="navbar" class="nav nav-list">
						<li class="nav-header">Facebook</li>
						<li>
						<a href="upload.html"><i class="icon-camera"></i> Upload photos</a>
						</li>
						<li>
						<a href="instances.html"><i class="icon-lock"></i> Manage instances</a>
						</li>
						<li class="active">
						<a href="users.html"><i class="icon-white icon-user"></i> Manage users</a>
						</li>
						<li class="nav-header">Broadmask</li>
						<li>
						<a href="settings.html"><i class="icon-cog"></i> Settings</a>
						</li>
						<li class="divider"></li>
						<li>
						<a href="about.html"><i class="icon-info-sign"></i> About</a>
						</li>
					</ul>
				</div>	
				<div id="app-content" class="span9">
					<div class="content">
						<div class="page-header">
							<h3>Manage users <small>Currently mapped users</small></h3>
						</div>	
						<div id="user_list">
						</div>
						<div id="user_refresh">
							<p class="light">
							BroadMask tries to automatically associate PGP key identifiers to their users using Facebook notes.<br/>
							You are advised to <strong>ensure</strong> the correctness of the key mappings before using them.</p>

							<p class="light">
							If you think a mapping should have been found, you can check for new key entries using the following button 
							</p>

							<p>
							<a id="user_mapping_refresh" data-loading-text="Refreshing" class="btn btn-primary"><i class="icon-white icon-refresh"></i> Update manually</a>
							</p>
						</div>
						<div class="page-header">
							<h3>Create mapping <small>Create mapping of friends to PGP keys</small></h3>
						</div>	
						<div style="display:none" id="create_user_success" class="alert alert-success">
							The user mapping has been created.
						</div>
						<form id="create_user_map" class="form form-horizontal">
							<div class="control-group">
								<label class="control-label"  for="friend_name">Friend name</label>
								<div class="controls">
									<input type="text" autocomplete="off" class="input-xlarge" id="friend_name">
									<p class="help-block light">Enter the name or id of your friend you want to enter a PGP-Key for</p>
								</div>
							</div>
							<div class="control-group">
								<label class="control-label" for="key_id">PGP-Key Identifier</label>
								<div class="controls">
									<input type="text" class="input-xlarge" id="key_id">
									<p class="help-block light">Enter the <strong>PGP Public-Key</strong> identifier or fingerprint you want to associate with this user. <br/>Note: A corresponding key must be found in your GPG keychain.</p>
								</div>
							</div>
							<div class="control-group">
								<label class="control-label" for="key_block">PGP Public-Key Block</label>
								<div class="controls">
									<textarea class="span6" id="key_block" rows="15"></textarea>
									<p class="help-block light">Alternatively, paste the PGP Public-Key Block you want to associate with this user. The embedded key will be imported to your keychain.</p>
								</div>
							</div>
							<div class="form-actions">
								<button id="btn-create-mapping" type="submit" class="btn btn-success">Create mapping</button>
								<button class="btn">Reset</button>
							</div>
						</form>

					</div>
				</div>
			</div>
		</body>
		<script src="../js/i18n.js" type="text/javascript" charset="utf-8"></script>
	</html>
