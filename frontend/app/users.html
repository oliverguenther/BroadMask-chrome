<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<title>Users</title>
		<link rel="stylesheet" href="../css/bootstrap.css" type="text/css" charset="utf-8"/>
		<link rel="stylesheet" href="../css/app.css" type="text/css" charset="utf-8"/>
		<script src="/shared/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/jquery.watch.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/bootstrap.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/app.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" charset="utf-8">
			function print_users(users) {
				var rows = [];
				$.each(users, function(i, user) {
					rows.push("<tr><td>");
					rows.push(user.name);
					rows.push("</td><td>");
					rows.push(user.id);
					rows.push("</td><td>");
					rows.push(user.keyid);
					rows.push('</td><td class="centered"><a href="javascript:keylist_remove(');
					rows.push(user.id); 
					rows.push(')"><i class="icon-minus-sign"></i></a></td></tr>');
				});
				$("#user_list").append('<table class="table table-bordered table-striped"><thead><tr><th>Name</th><th>ID</th><th>PGP Key-ID</th><th>Remove</th></tr></thead><tbody>' + rows.join("") + '</tbody></table>');

			}

			function keylist_remove(userid) {
				if (confirm("Do you want to disable the GPG key mapping for user " + userid + "?")) {
					console.log("FU");
				}
			}

			$(document).ready(function () {
				if (localStorage.cached_users) {
					var users = JSON.parse(localStorage.cached_users),
						friends = JSON.parse(localStorage.facebook_cache).friends,
						users_typeahead = [];

					print_users(users);
					$.each(users, function () {
						users_typeahead.push(this.name);
					});
					$("#instance_name").typeahead({
						"source": friends,
						"items": 5,
					});

					// mapping refresh
					$("#user_mapping_refresh").click(function () {
						$(this).button('loading');
						// TODO
						setTimeout(function () {
							$("#user_mapping_refresh").button('reset');
						}, 2000);
					});

				}
			});
		</script>
	</head>
	<body>
		<div id="header">
			<h1><span i18n>extName</span> <small><span i18n>title</span></small></h1>
		</div>
		<div class="container">
			<div class="row">
				<div class="span3">
					<ul id="navbar" class="nav nav-list">
						<li class="nav-header">Facebook</li>
						<li>
						<a href="updates.html"><i class="icon-eye-open"></i> Updates</a>
						</li>
						<li>
						<a href="upload.html"><i class="icon-camera"></i> Upload photos</a>
						</li>
						<li>
						<a href="instances.html"><i class="icon-lock"></i> Manage instances</a>
						</li>
						<li class="active">
						<a href="users.html"><i class="icon-white icon-user"></i> Manage users</a>
						</li>
						<li class="nav-header">Broadmask</li>
						<li>
						<a href="settings.html"><i class="icon-cog"></i> Settings</a>
						</li>
						<li class="divider"></li>
						<li>
						<a href="about.html"><i class="icon-info-sign"></i> About</a>
						</li>
					</ul>
				</div>	
				<div id="app-content" class="span9">
					<div class="content">
						<div class="page-header">
							<h3>Manage users <small>Currently mapped users</small></h3>
						</div>	
						<div id="user_list">
						</div>
						<div id="user_refresh">
							<p class="light">
							BroadMask tries to automatically associate PGP key identifiers to their users using Facebook notes.<br/>
							You are advised to <strong>ensure</strong> the correctness of the key mappings before using them.</p>

							<p class="light">
							If you think a mapping should have been found, you can check for new key entries using the following button 
							</p>

							<p>
								<a id="user_mapping_refresh" data-loading-text="Refreshing" class="btn btn-primary"><i class="icon-white icon-refresh"></i> Update manually</a>
							</p>
						</div>
						<div class="page-header">
							<h3>Create mapping <small>Create mapping of friends to PGP keys</small></h3>
						</div>	
						<form id="create_instance" class="form form-horizontal">
							<div class="control-group">
								<label class="control-label"  for="instance_name">Friend name</label>
								<div class="controls">
									<input type="text" autocomplete="off" class="input-xlarge" id="instance_name">
									<p class="help-block light">Enter the name or id of your friend you want to enter a PGP-Key for</p>
								</div>
							</div>
							<div class="control-group">
								<label class="control-label" for="key_id">PGP-Key Identifier</label>
								<div class="controls">
									<input type="text" class="input-xlarge" id="key_id">
									<p class="help-block light">Enter the <strong>PGP Public-Key</strong> identifier or fingerprint you want to associate with this user</p>
								</div>
							</div>
							<div class="control-group">
								<label class="control-label" for="key_block">PGP Public-Key Block</label>
								<div class="controls">
									<textarea class="span6" id="key_block" rows="15"></textarea>
									<p class="help-block light">Alternatively, paste the PGP Public-Key Block you want to associate with this user</p>
								</div>
							</div>
							<div class="form-actions">
								<button type="submit" class="btn btn-success">Create mapping</button>
								<button class="btn">Reset</button>
							</div>
						</form>

					</div>
				</div>
			</div>
		</body>
		<script src="../js/i18n.js" type="text/javascript" charset="utf-8"></script>
	</html>
