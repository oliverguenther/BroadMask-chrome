<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<title>Upload content</title>
		<link rel="stylesheet" href="../css/bootstrap.css" type="text/css" charset="utf-8"/>
		<link rel="stylesheet" href="../css/app.css" type="text/css" charset="utf-8"/>
		<script src="/shared/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/jquery.watch.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/bootstrap.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/app.js" type="text/javascript" charset="utf-8"></script>

		<script type="text/javascript" charset="utf-8">
			var bg = chrome.extension.getBackgroundPage();
			var bm = bg.broadmask;
			var imgid = 0;


			function enableShareForm(enable) {
				if (enable === true) {
					$("#share-select").removeAttr("disabled");
					$("#share-submit-btn").removeAttr("disabled");
					$("#share-reset-btn").removeAttr("disabled");
				} else {
					$(".uploadprogress").remove();
					$("#share-select").attr("disabled", "disabled");
					$("#share-submit-btn").attr("disabled", "disabled");
					$("#share-reset-btn").attr("disabled", "disabled");
				}
			}


			/*
			* Handle user files, and upload them to the image hoster
			* @param files an array of files
			*/
			function handleFiles (files) {
				"use strict";
				var that = this,
				i,
				f,
				len = files.length,
				reader,
				initRead;

				initRead = function (theFile) {
					return function (e) {
						var thumb = [];
						thumb.push('<div id="');
						thumb.push(imgid);
						thumb.push('" class="uploadprogress"><div class="picasa-thumbwrapper"><img class="thumb" src="');
						thumb.push(e.target.result);
						thumb.push('" title="');
						thumb.push(theFile.name);
						thumb.push('"/></div></div>');
						$("#files-preview").append(thumb.join(''));
						imgid++;
					};
				};
				// Loop through the FileList and render image files as thumbnails.
				for (i = 0; i < len; i = i + 1) {
					f = files[i];
					reader = new FileReader();
					// Only process image files.
					if (f.type.match('image.*')) {
						reader.onload = initRead(f);
						reader.onloadend = function () {
							if ($(".uploadprogress").length > 0) {
								enableShareForm(true);
							}
						};
						reader.readAsDataURL(f);
					}
				}


			};

			/** Event handler for HTML5 file inputs */
			function fileInputs (evt) {
				evt.stopPropagation();
				evt.preventDefault();

				if (evt.type === 'dragover') {
					evt.dataTransfer.dropEffect = 'copy';
					return;
				}
				var files = evt.target.files || evt.dataTransfer.files;
				if (files !== undefined) {
					handleFiles(files);
				}
			};


			$(document).ready(function() {



				$('#share-submit-btn').click(function () {
					var images = [],
					groupid = $("#share-select").val();
					$(".thumb").each(function() {
						var image = {}, 
						progress = document.createElement("progress");
						progress.value = 0;
						progress.max = 100;
						image.src = this.src;

						image.onprogress = function (e) {
							if (e.lengthComputable && progress !== null ) {
								progress.value = (e.loaded / e.total) * 100;
							}
						};

						image.error = error;

						image.success = function (xhr,	url) {
							var statusicon = document.createElement("img");
							if (url) {
								statusicon.src = chrome.extension.getURL("frontend/img/ok.png");
								$(progress).after("<p><a href=\"" + url +"\">Link</a></p>");
							} else {
								statusicon.src = chrome.extension.getURL("frontend/img/warning.png");
							}
							$(progress).replaceWith(statusicon);
						};

						// append to statusprogress
						$(this).parent().parent().append(progress);

						images.push(image);
					});
					bm.shareImages(groupid, images);
					return false;
				});

				$('#share-reset-btn').click(function () {
					enableShareForm(false);
					return false;
				});

				var instances = bm.module.get_stored_instances();
				if (Object.size(instances) > 0) {
					$("#create_users_note").hide();

					/** Fill instances select */
					var options = [];
					$.each(instances, function (id, instance) {
						options.push("<option value=\"");
						options.push(id);
						options.push("\">");
						options.push(instance.name);
						options.push("</option>");
					});
					$("#share-select").append(options.join(""));

					/** setup event listeners */
					var dropbox = document.getElementById("files-dropzone"),
					filepicker = document.getElementById("files-picker");
					dropbox.addEventListener('dragover', fileInputs, false);
					dropbox.addEventListener('drop', fileInputs, false);
					filepicker.addEventListener('change', fileInputs, false);
				} else {
					$("#share-form :input").attr("disabled", true);
				}
			});
		</script>

	</head>
	<body>
		<div id="header">
			<h1><span i18n>extName</span> <small><span i18n>title</span></small></h1>
		</div>
		<div class="container">
			<div class="row">
				<div class="span3">
					<ul id="navbar" class="nav nav-list">
						<li class="nav-header">Facebook</li>
						<li class="active">
						<a href="upload.html"><i class="icon-white icon-camera"></i> Upload photos</a>
						</li>
						<li>
						<a href="instances.html"><i class="icon-lock"></i> Manage instances</a>
						</li>
						<li>
						<a href="users.html"><i class="icon-user"></i> Manage users</a>
						</li>
						<li class="nav-header">Broadmask</li>
						<li>
						<a href="settings.html"><i class="icon-cog"></i> Settings</a>
						</li>
						<li class="divider"></li>
						<li>
						<a href="about.html"><i class="icon-info-sign"></i> About</a>
						</li>
					</ul>
				</div>	
				<div id="app-content" class="span9">
					<div class="content">
						<div class="alert-message" id="errormsg" style="display:none">
							<div id="errors">
							</div>
						</div>
						<div class="page-header">
							<h3>Upload photos <small> Share new photos with your group</small></h3>
						</div>	
						<div id="create_users_note" class="alert alert-block alert-error">
							<h4 class="alert-heading">No communication groups found</h4>
							<p>
							No group instances have been defined. <a href="instances.html">Create a new instance</a>
							</p>
						</div>
						<div id="picasa">
							<form id="share-form" class="form-horizontal">
								<div class="filepicker"><input id="files-picker" type="file" multiple=""></div>
								<div id="files-dropzone" class="dropzone">or drop some files here!</div>
								<hr>
								<div class="control-group">
									<label class="control-label" for="share-select">Share with</label>
									<div class="controls">
										<select id="share-select" disabled>
										</select>
									</div>
								</div>
								<div class="control-group error">
									<label class="control-label" for="share-select">Share to group only</label>
									<div class="controls">
										<input type="checkbox" id="optionsCheckbox" value="option1">
										<p class="help-block light">
										<span class="label label-important">Important!</span> Checking this will set the Facebook wall post privacy controls to all recipients you added! This will result in Facebook gaining knowledge about the members of your instance! <a href="#">Click here to learn more</a>.
									</div>
								</div>
								<div id="sharestatus"></div>
								<div class="form-actions">
									<button id="share-submit-btn" class="btn btn-success" disabled><i class="icon-white icon-arrow-up"></i> Share content</button>
									<button id="share-reset-btn"class="btn" disabled>Delete batch</button>
								</div>
							</form>
							<div id="files-preview"></div>
						</div>
					</div>
				</div>
			</div>
		</body>
		<script src="../js/i18n.js" type="text/javascript" charset="utf-8"></script>
	</html>
