<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf8">
		<title>Broadmask</title>
		<link rel="stylesheet" href="css/bootstrap.css" type="text/css" charset="utf-8"/>
		<link rel="stylesheet" href="css/popup.css" type="text/css" charset="utf-8"/>
		<script src="js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/bootstrap.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/broadmask/imageHosts/broadmask.uploader.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/broadmask/osn/broadmask.fb.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/broadmask/osn/broadmask.fb.api.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" charset="utf-8">

			var bg = chrome.extension.getBackgroundPage();
			var broadmask = bg.broadmask;

			function userid2name(userid) {
				if (localStorage[userid]) {
					return localStorage[userid];
				} else {
					return userid;
				}
			};

			function manage_keylist() {
				/** Update keylist */
				broadmask.getKeyMap(function (list) {
					$("#content-manage-keylist").empty();
					var count = 0,
					keys = [];
					$.each(list, function (userid, keyid) {
						keys.push("<tr><td>" + userid2name(userid) + "</td><td>" + keyid + "</td><td class=\"centered\"><a href=\"javascript:keylist_remove(" + userid + ")\"><i class=\"icon-minus-sign\"></i></a></td></tr>");
						count++;
					});
					$("#content-manage-keylist").html('<table class="table table-striped table-bordered"><tr><th>UserID</th><th>KeyID</th><th>Remove</th></tr>' + keys.join() + '</table>');
				});
			}

			function keylist_remove(userid) {
				if (confirm("Do you want to disable the GPG key mapping for user " + userid)) {
					console.log("FU");
				}
			}

			$(document).ready(function() {
				var osn = new Broadmask_facebook(document, "facebook");
				var uploader = new Broadmask_Uploader(document, "picasa", broadmask.imgHost, osn);
				manage_keylist();

				$(".navitem").click(function () {
					var contid = "#sec-" + $(this).attr('id');
					$(".navitem, .active").removeClass('active').find(".icon-white").removeClass("icon-white");
					$(this).addClass("active").children(":first").children(":first").addClass("icon-white");
					$(".nav-content").removeClass('active').filter(contid).addClass('active');
				});

				/** Update settings buttons */
				if (chrome.extension.getBackgroundPage().oauth.hasToken()) {
					$('#picasaauthbtn').val('Revoke Authorization');
					$('#picasaauthbtn').removeClass('btn-success').addClass('btn-danger');
					$('.picasaauth-toggle').show();
				}

				if (localStorage.fbtoken) {
					$('#facebookloginbtn').val('Revoke Authorization');
					$('#facebookloginbtn').removeClass('btn-success').addClass('btn-danger');	
					$('.facebookauth-toggle').show();
				}

				$('#picasaauthbtn').click(function (btn) {
					"use strict";
					var btn = this;
					if ($(btn).val() === 'Authorize') {
						broadmask.imgHost.performAuth(function () {
							$(btn).val('Revoke Authorization');
							$(btn).removeClass('btn-success').addClass('btn-danger');
						});
					} else {
						broadmask.imgHost.revokeAuth(function () {
							$(btn).val('Authorize');
							$(btn).removeClass('btn-danger').addClass('btn-success');
						});
					}
				});
				$('#facebookloginbtn').click(function (btn) {
					"use strict";
					var btn = this;
					if ($(btn).val() === 'Authorize') {
						fbAuth(function () {
							$(btn).val('Revoke Authorization');
							$(btn).removeClass('btn-success').addClass('btn-danger');
						});
					} else {
						fbRevokeAuth(function () {
							$(btn).val('Authorize');
							$(btn).removeClass('btn-danger').addClass('btn-success');
						});
					}
				});

			});
		</script>
	</head>

	<body>
		<div id="header">
			<div class="page-header">
				<h1><span i18n>extName</span> <small><span i18n>title</span></small></h1>
			</div>
		</div>
		<div class="container">
			<div class="row">

				<div class="span3">
					<ul id="navbar" class="nav nav-list">
						<li class="nav-header">Facebook</li>
						<li id="navitem-updates" class="navitem active">
						<a href="#"><i class="icon-white icon-eye-open"></i> Updates</a>
						</li>
						<li id="navitem-upload"  class="navitem">
						<a href="#"><i class="icon-camera"></i> Upload photos</a>
						</li>
						<li id="navitem-instances" class="navitem">
						<a href="#"><i class="icon-lock"></i> Manage instances</a>
						</li>
						<li id="navitem-users" class="navitem">
						<a href="#"><i class="icon-user"></i> Manage users</a>
						</li>
						<li class="nav-header" class="navitem">Broadmask</li>
						<li id="navitem-settings" class="navitem">
						<a href="#"><i class="icon-cog"></i> Settings</a>
						</li>
						<li class="divider"></li>
						<li>
						<a href="options.html"><i class="icon-info-sign"></i> About</a>
						</li>
					</ul>
				</div>
				<div class="span9">
					<section class="nav-content active" id="sec-navitem-updates">
					<h3>Updates</h3>
					<p>No new updates for your account.</p>
					</section>
					<section class="nav-content" id="sec-navitem-upload">
					<div class="page-header">
						<h3>Upload photos <small> Share new photos with your group</small></h3>
					</div>
					<div id="picasa">
						<div class="filepicker"><input id="files-picker" type="file" multiple=""></div>
						<div id="files-dropzone" class="dropzone">or drop some files here!</div>
						<div id="files-preview"></div>
						<hr>
						<form id="share-form" class="form-horizontal">
							<div class="control-group">
								<label class="control-label" for="share-select">Share with</label>
								<div class="controls">
									<select id="share-select" disabled>
									</select>
								</div>
							</div>
							<div id="sharestatus"></div>
							<div class="form-actions">
								<a id="share-submit-btn" class="btn btn-success" disabled><i class="icon-white icon-arrow-up"></i> Share content</a>
								<a id="share-reset-btn"class="btn" disabled>Delete batch</a>
							</div>
						</form>
					</div>
					</section>
					<section id="sec-navitem-instances"></section>
					<section class="nav-content" id="sec-navitem-users">
					<div class="page-header">
						<h3>Manage Users <small> Manage your friends PGP keys</small></h3>
					</div>
					<div id="content-manage-keylist">
					</div>
					</section>
					<section class="nav-content" id="sec-navitem-settings">
					<div id="authentication">
						<div class="page-header">
							<h3>Authentication <small>Image host / OSN authentication</small></h3>
						</div>
						<div id="picasa-auth">
							<h4>Picasa Authorization</h4>
							<p>
							In order to use the Image Sharing feature, you need a Picasa Webalbums Account linked to your Google account. You can authorize BroadMask to access your Account here.<br/>
							This button will redirect you to google in order to link your account to this app.
							</p>
							<p class="picasaauth-toggle" style="display:none">
							Your picasa account has been linked and is available for Broadmask.
							</p>
							<input type="button" id="picasaauthbtn" class="btn btn-small btn-primary" value="Authorize">
							<hr>
							<h4>Facebook Authorization</h4>
							<p>
							To use BroadMask services within your Facebook account, you'll need to authorize it to access your notes and friendlists.
							</p>
							<p class="facebookauth-toggle" style="display:none">
							Your facebook account has been linked and Broadmask has been authorized.
							</p>
							<input type="button" id="facebookloginbtn" class="btn btn-small btn-primary" value="Authorize">
						</div>
					</div>	
					</section>
				</div>
			</div>
		</body>
		<script type="text/javascript">

			// Replace span tags with localized message
			$(document).find('*[i18n]').each(function (){
				var msg;
				var tag = $(this);
				// Replace span tag with its content
				if (tag.is('span')) {
					msg = this.innerHTML;
					tag.replaceWith(chrome.i18n.getMessage(msg));
				} else if (tag.is('input') && tag.attr('type') === 'button') {
					// Replace button value with localized message
					msg = tag.attr("value");
					tag.attr('value', chrome.i18n.getMessage(msg));
				}
				// TODO remove debug
				if (chrome.i18n.getMessage(msg) === "") {
					debug("MISSING i18n key " + msg);
				}
			});
		</script>
	</html>
