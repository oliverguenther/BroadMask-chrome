<!DOCTYPE html>
<head>
	<link rel="stylesheet" href="css/bootstrap.css" type="text/css" charset="utf-8"/>
	<link rel="stylesheet" href="css/base.css" type="text/css" charset="utf-8"/>
	<script src="js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/broadmask/osn/broadmask.fb.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/broadmask/osn/broadmask.fb.api.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/broadmask/imageHosts/broadmask.uploader.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/ui/bootstrap-scrollspy.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/ui/bootstrap-buttons.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/ui/ui.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" charset="utf-8">

		// Globals
		var bg = chrome.extension.getBackgroundPage();
		var oauth = bg.oauth;
		var broadmask = bg.broadmask;

		$(document).ready(function() {
			// Setup bootstrap scrollspy
			$('body > .topbar').scrollSpy()
			// test localstorage for Google token
			if (oauth.hasToken()) {
				$("#gloginbtn").toggleClass("success primary disabled");
				$("#glogoutbtn").show();
				$("#gloginbtn").attr("value", "authorized");						
			}
			// test localstorage for FB token
			if (localStorage.fbtoken) {
				$("#fbloginbtn").toggleClass("success primary disabled");
				$("#fblogoutbtn").show();
				$("#fbloginbtn").attr("value", "authorized");
			}
			// Enable Picasa upload form when both allowed
			if (oauth.hasToken() && localStorage.fbtoken) {
				$("#Picasa-Upload").show();
			}

			var addIMG = function (blob) {

			}

			$("*").contents().filter(function () {
				return (this.nodeType === Node.TEXT_NODE && this.nodeValue.indexOf("BroadMask") != -1);
			}).get();
			return;

			// Test localstorage for friendslist
			var osn = new Broadmask_facebook(document, "facebook");
			var uploader = new Broadmask_Uploader(document, "picasa", broadmask.imgHost, osn);

			// Test find
			var objs = findBMPosts(function (posts) {
				// For each actor
				$.each(posts, function (key,val) {
					// For each image
					$.each(val, function () {
						broadmask.imgHost.fetchImage(this, function (entry, blob) {
							console.log(entry);
							if (entry.type !== "image/bmp") {
								addIMG(blob);
							} else if (entry.type === "image/bmp") {
								// Unwrap the BMP before displaying it
								var reader = new FileReader();
								// Only process image files.
								reader.onload = (function (theFile) {
									return function (e) {
										broadmask.unwrapImage(e.target.result, function (message, dataURL) {
											// TODO fix last char being incorrectly 0 (srpc message bug?)
											var img = document.createElement('img');
											img.src = dataURL.slice(0, -1);
											document.body.appendChild(img);
										});
									};
								})(blob);
								reader.readAsBinaryString(blob);
							}
						});
					});
				});
			});
		});

		// Called when FB SDK ready
		window.fbAsyncInit = function() {
			FB.init({
				appId      : '281109321931593',
				status     : true,
				cookie     : true,
				oauth      : true,
				xfbml      : true 
			});
		};

		// Load FB SDK
		(function(d){
			var js, id = 'facebook-jssdk'; if (d.getElementById(id)) {return;}
			js = d.createElement('script'); js.id = id; js.async = true;
			js.src = "https://connect.facebook.net/de_DE/all.js";
			d.getElementsByTagName('head')[0].appendChild(js);
		}(document));
	</script>
	<head>
		<meta charset="utf-8" />
		<title>Broadmask</title>
	</head>
	<body>
		<div id="fb-root"></div>
		<div class="topbar" data-scrollspy="scrollspy">
			<div class="fill">
				<div class="container">
					<a class="brand" href="#"><span i18n>extName</span></a>
					<ul class="nav">
						<li><a href="#help"><span i18n>help</span></a></li>
						<li><a href="#contact"><span i18n>contact</span></a></li>
					</ul>
				</div>
			</div>
		</div>
		<div class="container">
			<div class="content">
				<div class="page-header">
					<h1><span i18n>extName</span> <small><span i18n>title</span></small></h1>
				</div>
				<div class="row">
					<div class="span12">
						<div class="alert-message" id="errormsg" style="display:none">
							<a class="close" href="javascript:hideErrors()">Ã—</a>
							<div id="errors">
							</div>
						</div>
					</div>
					<div class="span12">
						<div id="Simple-Chrome-Login">
							<h2>Google Authorization</h2>
							<p>
							In order to use the Image Sharing feature, you need a Picasa Webalbums Account linked to your Google account. You can authorize BroadMask to access your Account here.<br/>
							This button will redirect you to google in order to link your account to this app.
							</p>
							<p><input type="button" id="gloginbtn" class="btn primary" onclick="imgAuth()" value="Login">
							<input style="display:hidden;" type="button" id="glogoutbtn" class="btn small danger" onclick="return imgLogout()" value="Revoke"></p>
							<h2>Facebook Authorization</h2>
							<p>
							To use BroadMask services within your Facebook account, you'll need to authorize it to access your notes and friendlists.
							</p>
							<p><input type="button" id="fbloginbtn" class="btn primary" onclick="fbAuth()" value="Login">
							<input style="display:hidden;" type="button" id="fblogoutbtn" class="btn small danger" onclick="return fbLogout()" value="Revoke"></p>
						</div>
						<div class="row">
							<div id="picasa" class="span12">
							</div>
							<div id="facebook" class="span12">
							</div>
						</div>
					</div>
				</div>
			</div>

			<footer>
			<p>Design from <a href="http://twitter.github.com/bootstrap">Bootstrap</a></p>
			</footer>

		</div> <!-- /container -->
		<script type="text/javascript">
			// Replace span tags with localized message
			$(document).find('*[i18n]').each(function (){
				var msg;
				var tag = $(this);
				// Replace span tag with its content
				if (tag.is('span')) {
					msg = this.innerHTML;
					tag.replaceWith(chrome.i18n.getMessage(msg));
				} else if (tag.is('input') && tag.attr('type') === 'button') {
					// Replace button value with localized message
					msg = tag.attr("value");
					tag.attr('value', chrome.i18n.getMessage(msg));
				}
				// TODO remove debug
				if (chrome.i18n.getMessage(msg) === "") {
					debug("MISSING i18n key " + msg);
				}
			});
		</script>
	</body>
</html>

