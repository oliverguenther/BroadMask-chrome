<!DOCTYPE html>
<head>
	<link rel="stylesheet" href="css/bootstrap.css" type="text/css" charset="utf-8"/>
	<link rel="stylesheet" href="css/base.css" type="text/css" charset="utf-8"/>
	<script src="js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/broadmask/osn/broadmask.facebook.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/ui/bootstrap-scrollspy.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/ui/bootstrap-buttons.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/ui/ui.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" charset="utf-8">

		// Globals
		var bg = chrome.extension.getBackgroundPage();
		var oauth = bg.oauth;
		var broadmask = bg.broadmask;

		$(document).ready(function() {
			// Setup bootstrap scrollspy
			$('body > .topbar').scrollSpy()
			// test localstorage for Google token
			if (oauth.hasToken()) {
				$("#gloginbtn").toggleClass("success primary disabled");
				$("#glogoutbtn").show();
				$("#gloginbtn").attr("value", "authorized");						
			}
			// test localstorage for FB token
			if (localStorage.fbtoken) {
				$("#fbloginbtn").toggleClass("success primary disabled");
				$("#fblogoutbtn").show();
				$("#fbloginbtn").attr("value", "authorized");
			}
			// Enable Picasa upload form when both allowed
			if (oauth.hasToken() && localStorage.fbtoken) {
				$("#Picasa-Upload").show();
			}

			// Test localstorage for friendslist
			if (localStorage.friendlists) {
				displayFriendlist();
			}
			// Setup handler
			var dropZone = document.getElementById('dropzone');
			dropZone.addEventListener('dragover', handleDragOver, false);
			dropZone.addEventListener('drop', handleFileDrop, false);
			document.getElementById('file').addEventListener('change', handleFileSelect, false);


		});

		// Called when FB SDK ready
		window.fbAsyncInit = function() {
			FB.init({
				appId      : '281109321931593',
				status     : true,
				cookie     : true,
				oauth      : true,
				xfbml      : true 
			});
		};

		// Load FB SDK
		(function(d){
			var js, id = 'facebook-jssdk'; if (d.getElementById(id)) {return;}
			js = d.createElement('script'); js.id = id; js.async = true;
			js.src = "https://connect.facebook.net/de_DE/all.js";
			d.getElementsByTagName('head')[0].appendChild(js);
		}(document));
	</script>
	<head>
		<meta charset="utf-8" />
		<title>Broadmask</title>
	</head>
	<body>
		<div id="fb-root"></div>
		<div class="topbar" data-scrollspy="scrollspy">
			<div class="fill">
				<div class="container">
					<a class="brand" href="#"><span i18n>extName</span></a>
					<ul class="nav">
						<li><a href="#help"><span i18n>help</span></a></li>
						<li><a href="#contact"><span i18n>contact</span></a></li>
					</ul>
				</div>
			</div>
		</div>
		<div class="container">
			<div class="content">
				<div class="page-header">
					<h1><span i18n>extName</span> <small><span i18n>title</span></small></h1>
				</div>
				<div class="row">
					<div class="span12">
						<div class="alert-message" id="errormsg" style="display:none">
							<a class="close" href="javascript:hideErrors()">Ã—</a>
							<div id="errors">
							</div>
						</div>
					</div>
					<div class="span12">
						<div id="Simple-Chrome-Login">
							<h2>Google Authorization</h2>
							<p>
							In order to use the Image Sharing feature, you need a Picasa Webalbums Account linked to your Google account. You can authorize BroadMask to access your Account here.<br/>
							This button will redirect you to google in order to link your account to this app.
							</p>
							<p><input type="button" id="gloginbtn" class="btn primary" onclick="imgAuth()" value="Login">
							<input style="display:hidden;" type="button" id="glogoutbtn" class="btn small danger" onclick="return imgLogout()" value="Revoke"></p>
							<h2>Facebook Authorization</h2>
							<p>
							To use BroadMask services within your Facebook account, you'll need to authorize it to access your notes and friendlists.
							</p>
							<p><input type="button" id="fbloginbtn" class="btn primary" onclick="fbAuth()" value="Login">
							<input style="display:hidden;" type="button" id="fblogoutbtn" class="btn small danger" onclick="return fbLogout()" value="Revoke"></p>
						</div>
						<div id="row">
							<hr/>
						</div>
						<div id="Picasa-Upload" class="row">
							<div class="span10">
								<div class="alert-message block-message success">
									<p>
									<strong>You are now logged in</strong><br/>
									You have successfully configured BroadMask and are now ready to use the Plugin!
									<ul>
										<li>Select your friendlist from the picker to define the group you're sharing with</li>
										<li>Select one or multiple images using the button below, or drag&amp;drop some images on the designated area</li>
										<li>The files will be encrypted and immediately uploaded to your picasa account</li>
										<li>From there on, the chosen friends will be notified of the pictures</li>
									</ul>
									</p>
								</div>
							</div>
							<div class="span6" id="friends">
								<p>
								You're friendlists have not yet been fetched	
								</p>
							</div>
							<div class="span7 offset3">
								<p>
								<a href="javascript:updateKeys()">Retrieve Keys!</a>
								</p>
								<p><input type="button" id="fbloginbtn" class="btn info" onclick="updateFriendlists(document)" i18n value="btn_refresh_friendlist"/></p>
							</div>
							<div class="span9 offset1" id="selectedfriends"></div>
							<div class="clearfix"></div>
							<div class="span9 offset1">
								<h2>Upload new images</h2>
							</div>
							<div id="filechoose" class="span5 offset1">
								<p>Press this button to select a file to upload..</p>
								<input type="file" id="file" multiple></input>
							</div>
							<div class="span4">
								<div id="dropzone">
									.. or drag a picture here to upload it to Picasa WebAlbums.
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<footer>
			<p>Design from <a href="http://twitter.github.com/bootstrap">Bootstrap</a></p>
			</footer>

		</div> <!-- /container -->
		<script type="text/javascript">
			// Replace span tags with localized message
			$(document).find('*[i18n]').each(function (){
				var msg;
				var tag = $(this);
				// Replace span tag with its content
				if (tag.is('span')) {
					msg = this.innerHTML;
					tag.replaceWith(chrome.i18n.getMessage(msg));
				} else if (tag.is('input') && tag.attr('type') === 'button') {
					// Replace button value with localized message
					msg = tag.attr("value");
					tag.attr('value', chrome.i18n.getMessage(msg));
				}
				// TODO remove debug
				if (chrome.i18n.getMessage(msg) === "") {
					debug("MISSING i18n key " + msg);
				}
			});
		</script>
	</body>
</html>
