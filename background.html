<html>
	<head>
		<!-- utils -->
		<script src="js/util/chrome_ex_oauth.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/util/chrome_ex_oauth_simple.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/util/permafrost/permafrost.js" type="text/javascript" charset="utf-8"></script>
		<!-- Broadmask native client implementation -->
		<script src="js/broadmask/nacl/broadmask.nacl.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/broadmask/nacl/crypto/broadmask.nacl.aes.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/broadmask/nacl/crypto/broadmask.nacl.be.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/broadmask/nacl/crypto/broadmask.nacl.openpgp.js" type="text/javascript" charset="utf-8"></script>
		<!-- Broadmask JS implementation -->
		<script src="js/broadmask/broadmask.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/broadmask/imageHosts/broadmask.picasa.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/broadmask/crypto/broadmask.aes.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/broadmask/crypto/broadmask.be.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/broadmask/crypto/broadmask.openpgp.js" type="text/javascript" charset="utf-8"></script>

		<script type="text/javascript" charset="utf-8">

					function plugin0()
		{
			return document.getElementById('plugin0');
		}
		plugin = plugin0;
		function addEvent(obj, name, func)
		{
			if (window.addEventListener) {
				obj.addEventListener(name, func, false); 
			} else {
				obj.attachEvent("on"+name, func);
			}
		}

		function load()
		{
			addEvent(plugin(), 'test', function(){
				alert("Received a test event from the plugin.")
			});
		}
		function pluginLoaded() {
			alert("Plugin loaded!");
		}

		function addTestEvent()
		{
			addEvent(plugin(), 'echo', function(txt,count){
				alert(txt+count);
			});
		}

		function testEvent()
		{
			plugin().testEvent();
		}

		function pluginValid()
		{
			if(plugin().valid){
				alert(plugin().echo("This plugin seems to be working!"));
			} else {
				alert("Plugin is not working :(");
			}
		}

			var oauth = ChromeExOAuth.initBackgroundPage({
				'request_url': 'https://www.google.com/accounts/OAuthGetRequestToken',
				'authorize_url': 'https://www.google.com/accounts/OAuthAuthorizeToken',
				'access_url': 'https://www.google.com/accounts/OAuthGetAccessToken',
				'consumer_key': 'anonymous',
				'consumer_secret': 'anonymous',
				'scope': 'https://picasaweb.google.com/data',
				'app_name': 'BroadMask'
			});

			var broadmask = new Broadmask_nacl();

			Object.size = function(obj) {
				var size = 0, key;
				for (key in obj) {
					if (obj.hasOwnProperty(key)) size++;
				}
				return size;
			};

			/** caches images for popup */
			var unread = {}, 
			badgecount = Object.size(unread),
			bmTabid = null;

			if (localStorage.unreadItems) {
				unread = JSON.parse(localStorage.unreadItems);
			}

			function setRead(key) {
				delete unread[key];
				if (badgecount > 0) {
					badgecount--;
				}
				localStorage.unreadItems = JSON.stringify(unread);
				chrome.browserAction.setBadgeText({text: ""});
			}

			function newUnread(key, val) {
				if (!key || !val) {
					return;
				}
				if (!unread.hasOwnProperty(key)) {
					badgecount++;
				}
				unread[key] = val;
				localStorage.unreadItems = JSON.stringify(unread);
				chrome.browserAction.setBadgeText({text: badgecount.toString()});
				chrome.browserAction.setBadgeBackgroundColor({color: [118, 248, 123, 255]});
			}

			function getParameterByName(name, url) {
				name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
				var regexS = "[\\?&#]" + name + "=([^&#]*)";
				var regex = new RegExp(regexS);
				var results = regex.exec(url);
				if(results == null)
					return "";
				else
					return decodeURIComponent(results[1].replace(/\+/g, " "));
			}

			function onFacebookLogin(callback) {
				chrome.tabs.getAllInWindow(null, function(tabs) {
					for (var i = 0; i < tabs.length; i++) {
						if (tabs[i].url.indexOf("https://www.facebook.com/connect/login_success.html") == 0) {
							var params = getParameterByName("access_token",tabs[i].url);
							localStorage.fbtoken = params;
							chrome.tabs.onUpdated.removeListener(onFacebookLogin);
							chrome.tabs.remove(tabs[i].id);
							callback();
							return;
						}
					}
				});
			};



			chrome.extension.onRequest.addListener(
				function(request, sender, sendResponse) {
					if (typeof request !== 'object') {
						return;
					}

					if (request.message === 'newBMdataFromCS') {
						broadmask.handleImages(request.data, function() {
							if (bmTabid !== null) {
								chrome.tabs.sendRequest(bmTabid, 'updateStatus', function() {
									chrome.tabs.update(bmTabid, {active: true});
								});
							}
						});
					}

				});

				chrome.browserAction.onClicked.addListener(function() {
					chrome.tabs.create({url: chrome.extension.getURL("broadmask.html")}, function(tab) {
						bmTabid = tab.id;
						chrome.tabs.onRemoved.addListener(function () {
							bmTabid = null;
						});
					});
				});
			</script>
		</head>	
		<body>
			<div id="broadmask_listener"></div>
			<script type="text/javascript">
				// Prepare broadmask (load nacl module)
				broadmask.run();
			</script>
			<object id="plugin0" type="application/x-broadmask" width="300" height="300">
				<param name="onload" value="pluginLoaded" />
			</object><br />
		</body>
	</body>
</html>
