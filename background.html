<html>
	<head>
		<!-- Google oAuth	 -->
		<script src="js/util/chrome_ex_oauth.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/util/chrome_ex_oauth_simple.js" type="text/javascript" charset="utf-8"></script>
		<!-- Broadmask Wrapper module -->
		<script src="js/broadmask/broadmask.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" charset="utf-8">

			// Broadmask Module
			broadmask = {};
			BroadmaskModule = null;  // Global application object.
			statusText = 'NO-STATUS';
			var callbacks;
			var SRPC_MAXLEN = 65000; // max length is 65228

			var oauth = ChromeExOAuth.initBackgroundPage({
				'request_url': 'https://www.google.com/accounts/OAuthGetRequestToken',
				'authorize_url': 'https://www.google.com/accounts/OAuthAuthorizeToken',
				'access_url': 'https://www.google.com/accounts/OAuthGetAccessToken',
				'consumer_key': 'anonymous',
				'consumer_secret': 'anonymous',
				'scope': 'https://picasaweb.google.com/data',
				'app_name': 'BroadMask'
			});

			function getParameterByName(name, url) {
				name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
				var regexS = "[\\?&#]" + name + "=([^&#]*)";
				var regex = new RegExp(regexS);
				var results = regex.exec(url);
				if(results == null)
					return "";
				else
					return decodeURIComponent(results[1].replace(/\+/g, " "));
			}

			function onFacebookLogin() {
				chrome.tabs.getAllInWindow(null, function(tabs) {
					for (var i = 0; i < tabs.length; i++) {
						if (tabs[i].url.indexOf("https://www.facebook.com/connect/login_success.html") == 0) {
							var params = getParameterByName("access_token",tabs[i].url);
							console.log("Found FB api params" + params);
							localStorage.fbtoken = params;
							chrome.tabs.onUpdated.removeListener(onFacebookLogin);
							chrome.tabs.remove(tabs[i].id);
							chrome.tabs.update(tabId, {selected: true}, function () {
								window.location.reload();
							});
							return;
						}
					}
				});
			};

			chrome.browserAction.onClicked.addListener(function(tab) {
				chrome.tabs.create({'url': chrome.extension.getURL('init.html')}, function(tab) {
				});
			});

			/* Broadmask Native was loaded successful*/
			function moduleDidLoad() {
				BroadmaskModule = document.getElementById('broadmask');
				statusText = "SUCCESS";
				console.log("Broadmask has loaded");
				BroadmaskModule.addEventListener('message', handleMessage, false);
			}

			function parsemethod(data) {
				if (!data || typeof data != 'string') {
					return null;
				}
				var call = new Object();
				var offset = data.indexOf(" ");
				if (offset == -1) {
					return null; // couldn't parse method name
				}
				call.methodName = data.substr(0, offset);
				// get data offset
				var doffset = data.indexOf("data:") || data.length -1;
				var params = data.substr(offset, doffset);
				// parse parameters
				var regex = /(\w+):(\w+)/g;
				var matches = regex.exec(params);
				while (matches) {
					var param = matches[0];
					var value = matches[1];
					call[param] = value;
				}

				return call;

			}

			/** Handle an incoming message from Broadmask code */
			function handleMessage(message_event) {
				var message = parsemethod(message_event.data);
				console.log(message_event.data.length);
			}

			/** Send request to wrap image to BMP */
			function wrapImage(image, callback) {
				var uid = Math.round(Math.random() * 1024);				
				if (callback && typeof callback === 'function') {
					msgcallback[uid] = callback;
				}
				if (BroadmaskModule) {
					// split messages if necessary (SRPC BUG)
					if (image.length > SRPC_MAXLEN) {
						console.log("Image size is " + image.length + " , needs to be split");
						var packetid = 0;
						while ((image.length % SRPC_MAXLEN) != 0)  {
							var packet = image.substr(0, SRPC_MAXLEN);	
							image = image.substring(SRPC_MAXLEN);
							BroadmaskModule.postMessage("handlePacket uid:" + uid + "		part:" + packetid + "		data:" + packet);
							packetid++;
						}
						if (image.length > 0) {
							// Send last packet, marked by negative id
							console.log("Sending last packet after " + packet + "		packets");
							packet = '-1'; 
							BroadmaskModule.postMessage("handlePacket uid:" + uid + "		part:" + packetid + "		data:" + image);
						}
					} else {
						// Image is smaller than SRPC maxlen, send as one packet
						BroadmaskModule.postMessage("wrapImage uid: " + uid + "		data:" + image);
					}
					// Tell Broadmask to wrap the image
					BroadmaskModule.postMessage("wrapImage uid:" + uid);
				} else {
					console.log("Error: Can't wrap image as module was not loaded! Status is " + statusText);
				}
			}

		</script>
	</head>	
	<body>
		<div id="listener">
			<script type="text/javascript">
				var listener = document.getElementById('listener');
				listener.addEventListener('load', moduleDidLoad, true);
			</script>

			<embed name="broadmask"
			id="broadmask"
			width=0 height=0
			src="broadmask/broadmask.nmf"
			type="application/x-nacl" />
		</div>
		<h2>Status</h2>
		<div id="status_field">NO-STATUS</div>
	</body>
</body>
</html>
