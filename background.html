<html>
	<head>
		<!-- Google oAuth	 -->
		<script src="js/util/chrome_ex_oauth.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/util/chrome_ex_oauth_simple.js" type="text/javascript" charset="utf-8"></script>
		<!-- Broadmask Wrapper module -->
		<script src="js/broadmask/broadmask.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/broadmask/broadmask.nacl.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" charset="utf-8">

			var oauth = ChromeExOAuth.initBackgroundPage({
				'request_url': 'https://www.google.com/accounts/OAuthGetRequestToken',
				'authorize_url': 'https://www.google.com/accounts/OAuthAuthorizeToken',
				'access_url': 'https://www.google.com/accounts/OAuthGetAccessToken',
				'consumer_key': 'anonymous',
				'consumer_secret': 'anonymous',
				'scope': 'https://picasaweb.google.com/data',
				'app_name': 'BroadMask'
			});

			function getParameterByName(name, url) {
				name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
				var regexS = "[\\?&#]" + name + "=([^&#]*)";
				var regex = new RegExp(regexS);
				var results = regex.exec(url);
				if(results == null)
					return "";
				else
					return decodeURIComponent(results[1].replace(/\+/g, " "));
			}

			function onFacebookLogin() {
				chrome.tabs.getAllInWindow(null, function(tabs) {
					for (var i = 0; i < tabs.length; i++) {
						if (tabs[i].url.indexOf("https://www.facebook.com/connect/login_success.html") == 0) {
							var params = getParameterByName("access_token",tabs[i].url);
							console.log("Found FB api params" + params);
							localStorage.fbtoken = params;
							chrome.tabs.onUpdated.removeListener(onFacebookLogin);
							chrome.tabs.remove(tabs[i].id);
							chrome.tabs.update(tabId, {selected: true}, function () {
								window.location.reload();
							});
							return;
						}
					}
				});
			};

			chrome.browserAction.onClicked.addListener(function(tab) {
				chrome.tabs.create({'url': chrome.extension.getURL('init.html')}, function(tab) {
				});
			});





		</script>
	</head>	
	<body>
    <div id="broadmask_listener"></div>
    <script type="text/javascript">
      var broadmask = new broadmask();
    </script>
	</body>
</body>
</html>
